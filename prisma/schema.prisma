generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id        String   @id @default(uuid())
  name      String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admins")
}

model User {
  id                String               @id @default(uuid())
  email             String               @unique
  password          String
  name              String?
  role              String               @default("USER")
  emailVerified     Boolean              @default(false)
  approvedByAdmin   Boolean              @default(false)
  approvedAt        DateTime?
  approvedById      String?
  dateOfBirth       DateTime
  gender            String
  height            Float
  weight            Float
  sidoCode          String
  guGunCode         String
  diseaseHistory    DiseaseHistory?
  healthCheckups    HealthCheckup[]
  userInterestGroup UserInterestGroup?
  learningProgress  UserLearningProgress[]
  dailyLearningSessions DailyLearningSession[]
  approvedBy        User?                @relation("UserApprovals", fields: [approvedById], references: [id])
  approvedUsers     User[]               @relation("UserApprovals")
  sidoRegion        Region               @relation("UserSido", fields: [sidoCode], references: [code])
  guGunRegionDetail RegionDetail         @relation("UserGuGun", fields: [guGunCode], references: [code])
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  deletedAt         DateTime?

  @@map("users")
}

model EmailVerification {
  id         String   @id @default(uuid())
  email      String   @unique
  code       String
  expiresAt  DateTime
  verifiedAt DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("email_verifications")
}

model InstitutionConfig {
  id                         String @id @default(uuid())
  name                       String @unique
  emailForm                  String @unique
  contactPersonName          String?
  contactPersonPhone         String?
  contactPersonEmail         String?
  businessRegistrationNumber String?
  pointPoolTotal             BigInt
  pointPoolRemaining         BigInt
  pointLimitPerUser          Int
  affiliationCodes           Json

  @@map("institution_configs")
}

model HealthCheckup {
  id                       String   @id @default(uuid())
  userId                   String
  checkupDate              DateTime?
  bmi                      Float?
  waistCircumference       Float?
  systolicBloodPressure    Int?
  diastolicBloodPressure   Int?
  totalCholesterol         Int?
  hdlCholesterol           Int?
  ldlCholesterol           Int?
  triglycerides            Int?
  hemoglobin               Float?
  ast                      Int?
  alt                      Int?
  serumCreatinine          Float?
  glomerularFiltrationRate Float?
  user                     User     @relation(fields: [userId], references: [id])
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@map("health_checkups")
}

model DiseaseHistory {
  id                         String   @id @default(uuid())
  userId                     String   @unique
  chronicDiseases            String[] @default([])
  chronicRespiratoryDiseases String[] @default([])
  chronicRespiratoryOther    String?
  chronicArthritis           String[] @default([])
  osteoarthritis             String?
  chronicArthritisOther      String?
  pastChronicDiseases        String[] @default([])
  cancerHistory              String[] @default([])
  cancerOther                String?
  isSmoking                  String?
  isDrinking                 String?
  user                       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  @@map("disease_histories")
}

model UserInterestGroup {
  id                     String               @id @default(uuid())
  userId                 String               @unique
  learningContentGroupId String
  learningContentGroup   LearningContentGroup @relation(fields: [learningContentGroupId], references: [id], onDelete: Cascade)
  user                   User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt

  @@map("user_interest_groups")
}

model LearningContentGroup {
  id                 String               @id @default(uuid())
  name               String
  description        String?
  topics             Topic[]
  userInterestGroups UserInterestGroup[]
  learningProgress   UserLearningProgress[]
  dailyLearningSessions DailyLearningSession[]
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  deletedAt          DateTime?

  @@map("learning_content_groups")
}

model Topic {
  id                     String               @id @default(uuid())
  learningContentGroupId String
  title                  String
  description            String?
  order                  Int
  contents               Content[]
  learningContentGroup   LearningContentGroup @relation(fields: [learningContentGroupId], references: [id], onDelete: Cascade)
  userProgressAsCurrent  UserLearningProgress[] @relation("CurrentTopic")
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  deletedAt              DateTime?

  @@map("topics")
}

model Content {
  id                    String                @id @default(uuid())
  topicId               String
  title                 String
  order                 Int
  topic                 Topic                 @relation(fields: [topicId], references: [id], onDelete: Cascade)
  steps                 Step[]
  userProgressAsCurrent UserLearningProgress[] @relation("CurrentContent")
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  deletedAt             DateTime?

  @@map("contents")
}

model Step {
  id                    String                @id @default(uuid())
  contentId             String
  pageTitle             String
  order                 Int
  contentItems          StepContentItem[]
  content               Content               @relation(fields: [contentId], references: [id], onDelete: Cascade)
  userProgressAsCurrent UserLearningProgress[] @relation("CurrentStep")
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  deletedAt             DateTime?

  @@map("steps")
}

model StepContentItem {
  id        String          @id @default(uuid())
  stepId    String
  type      ContentItemType
  order     Int
  data      Json
  step      Step            @relation(fields: [stepId], references: [id], onDelete: Cascade)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  deletedAt DateTime?

  @@map("step_content_items")
}

enum ContentItemType {
  SPEECH_BUBBLE
  TEXT
  IMAGE
  DATE
  LABEL_TEXT_FIELD
  CHECKBOX
  QNA
}

model UserLearningProgress {
  id                     String               @id @default(uuid())
  userId                 String
  learningContentGroupId String
  currentTopicId         String?
  currentContentId       String?
  currentStepId           String?
  isCompleted            Boolean              @default(false)
  completedAt            DateTime?
  user                   User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  learningContentGroup   LearningContentGroup @relation(fields: [learningContentGroupId], references: [id], onDelete: Cascade)
  dailyLearningSessions  DailyLearningSession[]
  currentTopic           Topic?               @relation("CurrentTopic", fields: [currentTopicId], references: [id])
  currentContent         Content?             @relation("CurrentContent", fields: [currentContentId], references: [id])
  currentStep            Step?                @relation("CurrentStep", fields: [currentStepId], references: [id])
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt

  @@unique([userId, learningContentGroupId])
  @@map("user_learning_progress")
}

model DailyLearningSession {
  id                     String               @id @default(uuid())
  userId                 String
  learningContentGroupId String
  userProgressId         String
  sessionDate            DateTime             @default(now())
  topicsCompleted        Int                  @default(0)
  contentsCompleted      Int                  @default(0)
  stepsCompleted         Int                  @default(0)
  lastLearningAt         DateTime             @default(now())
  user                   User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  learningContentGroup   LearningContentGroup @relation(fields: [learningContentGroupId], references: [id], onDelete: Cascade)
  userProgress           UserLearningProgress @relation(fields: [userProgressId], references: [id], onDelete: Cascade)
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt

  @@unique([userId, learningContentGroupId, sessionDate])
  @@map("daily_learning_sessions")
}

model Region {
  code        String          @id
  name        String
  details     RegionDetail[]
  users       User[]          @relation("UserSido")
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@map("regions")
}

model RegionDetail {
  code        String   @id
  name        String
  regionCode  String
  region      Region   @relation(fields: [regionCode], references: [code], onDelete: Cascade)
  users       User[]   @relation("UserGuGun")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([regionCode])
  @@map("region_details")
}
